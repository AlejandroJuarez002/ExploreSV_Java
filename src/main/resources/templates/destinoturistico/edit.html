<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layouts/_mainLayout"
      xmlns="http://www.w3.org/1999/html">

<div layout:fragment="content">
    <h1>Editar destino</h1>
    <form id="destinoForm"
          th:action="@{/destinoTuristicos/save}"
          th:object="${destinoTuristico}"
          method="post"
          enctype="multipart/form-data">

        <input type="hidden" th:field="*{id}">

        <!-- Campos normales -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="nombre">Nombre</label>
                    <input type="text" class="form-control" th:field="*{nombre}" id="nombre" placeholder="Nombre del destino" maxlength="100" required>
                </div>
            </div>
        </div>

        <!-- Descripción -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="descripcion">Descripción</label>
                    <textarea class="form-control" th:field="*{descripcion}" id="descripcion" cols="12" rows="3" maxlength="2500" required></textarea>
                </div>
            </div>
        </div>

        <!-- Ubicación -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="ubicacion">Ubicación</label>
                    <textarea class="form-control" th:field="*{ubicacion}" id="ubicacion" cols="12" rows="3" maxlength="300" required></textarea>
                </div>
            </div>
        </div>

        <!-- Horario -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="horario">Horario</label>
                    <textarea class="form-control" th:field="*{horario}" id="horario" cols="12" rows="3" maxlength="100" required></textarea>
                </div>
            </div>
        </div>

        <!-- Departamento -->
        <select class="form-control" th:field="*{departamento}" id="departamento" required>
            <option value="">Selecciona un departamento</option>
            <option th:each="depto : ${departamentos}"
                    th:value="${depto.id}"
                    th:text="${depto.nombre}"
                    th:selected="${depto.id eq destinoTuristico.departamento?.id}">
            </option>
        </select>

        <!-- Categoría -->
        <select class="form-control" th:field="*{categoria}" id="categoria" required>
            <option value="">Selecciona una categoría</option>
            <option th:each="cat : ${categorias}"
                    th:value="${cat.id}"
                    th:text="${cat.nombre}"
                    th:selected="${cat.id eq destinoTuristico.categoria?.id}">
            </option>
        </select>

        <!-- Subir nuevas imágenes -->
        <div class="form-group mt-3">
            <label for="imagenFiles">Nuevas imágenes</label>
            <input type="file" id="imagenFiles" name="imagenFiles" multiple class="form-control"/>
        </div>

        <!-- Previsualización de nuevas imágenes -->
        <div class="form-group mt-2" id="previewContainer" style="display:flex; flex-wrap:wrap; gap:10px;"></div>

        <!-- Imágenes actuales con opción de eliminar -->
        <div class="form-group mt-3">
            <label>Imágenes actuales</label>
            <div class="d-flex flex-wrap">
                <div th:each="img : ${destinoTuristico.imagenes}" class="p-2 text-center"
                     style="position:relative; display:inline-block;">

                    <!-- Imagen -->
                    <img th:if="${img.base64Image != null}"
                         th:src="'data:image/png;base64,' + ${img.base64Image}"
                         alt="Imagen destino"
                         style="width:100px;height:100px;object-fit:cover;border-radius:5px;display:block;margin:auto;">

                    <!-- Botón "X" para marcar eliminación -->
                    <button type="button"
                            class="btn btn-sm btn-danger"
                            style="position:absolute; top:2px; right:2px; border-radius:50%; padding:2px 6px; line-height:1;"
                            onclick="toggleDelete(this)">
                        ×
                    </button>

                    <!-- Checkbox oculto -->
                    <input type="checkbox" name="deleteImages" th:value="${img.id}" style="display:none;">
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div class="form-group mt-3">
            <button type="submit" class="btn btn-primary">Guardar</button>
            <a th:href="@{/destinoTuristicos}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>

    <script>
        // =============== IMÁGENES EXISTENTES (BD) ===============
        function toggleDelete(btn) {
            let container = btn.closest("div");
            let checkbox = container.querySelector("input[type=checkbox]");

            if (checkbox.checked) {
                checkbox.checked = false;
                btn.classList.remove("btn-secondary");
                btn.classList.add("btn-danger");
            } else {
                checkbox.checked = true;
                btn.classList.remove("btn-danger");
                btn.classList.add("btn-secondary");
            }
        }

        // =============== IMÁGENES NUEVAS (LOCALES) ===============
        const inputFiles = document.getElementById('imagenFiles');
        const previewContainer = document.getElementById('previewContainer');

        inputFiles.addEventListener('change', function () {
            Array.from(this.files).forEach((file) => {
                const reader = new FileReader();

                reader.onload = function (e) {
                    // Crear contenedor de imagen con botón X
                    const container = document.createElement('div');
                    container.style.position = 'relative';
                    container.style.display = 'inline-block';

                    // Imagen
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '5px';
                    img.style.margin = '5px';

                    // Botón X
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.innerHTML = '×';
                    btn.className = 'btn btn-sm btn-danger';
                    btn.style.position = 'absolute';
                    btn.style.top = '2px';
                    btn.style.right = '2px';
                    btn.style.borderRadius = '50%';
                    btn.style.padding = '2px 6px';
                    btn.style.lineHeight = '1';

                    // Evento eliminar SOLO para nuevas imágenes
                    btn.onclick = () => {
                        container.remove();

                        // Quitar el archivo del input (reconstruimos el FileList)
                        const dt = new DataTransfer();
                        Array.from(inputFiles.files)
                            .forEach(f => {
                                if (f !== file) dt.items.add(f);
                            });
                        inputFiles.files = dt.files;
                    };

                    // Armar contenedor
                    container.appendChild(img);
                    container.appendChild(btn);
                    previewContainer.appendChild(container);
                };

                reader.readAsDataURL(file);
            });
        });
    </script>
</div>
</html>
