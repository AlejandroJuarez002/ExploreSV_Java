<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layouts/_mainLayout" xmlns="http://www.w3.org/1999/html">

<div layout:fragment="content">
    <h1>Editar destino</h1>
    <form id="destinoForm"
          th:action="@{/destinoTuristicos/save}"
          th:object="${destinoTuristico}"
          method="post"
          enctype="multipart/form-data">

        <input type="hidden" th:field="*{id}">

        <!-- Campos normales -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="nombre">Nombre</label>
                    <input type="text" class="form-control" th:field="*{nombre}" id="nombre" placeholder="Nombre del destino" required>
                </div>
            </div>
        </div>

        <!-- Descripción -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="descripcion">Descripción</label>
                    <textarea class="form-control" th:field="*{descripcion}" id="descripcion" cols="12" rows="3" required></textarea>
                </div>
            </div>
        </div>

        <!-- Ubicación -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="ubicacion">Ubicación</label>
                    <textarea class="form-control" th:field="*{ubicacion}" id="ubicacion" cols="12" rows="3" required></textarea>
                </div>
            </div>
        </div>

        <!-- Horario -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="horario">Horario</label>
                    <textarea class="form-control" th:field="*{horario}" id="horario" cols="12" rows="3" required></textarea>
                </div>
            </div>
        </div>

        <!-- Imágenes actuales -->
        <div class="form-group mt-3">
            <label>Imágenes actuales</label>
            <div class="d-flex flex-wrap">
                <div th:each="img : ${destinoTuristico.imagenes}" class="p-1">
                    <img th:if="${img.base64Image != null}"
                         th:src="'data:image/png;base64,' + ${img.base64Image}"
                         alt="Imagen destino"
                         style="width:100px;height:100px;object-fit:cover;border-radius:5px;">
                </div>
            </div>
        </div>

        <!-- Subir nuevas imágenes -->
        <div class="form-group mt-3">
            <label for="imagenFiles">Nuevas imágenes</label>
            <input type="file" id="imagenFiles" accept="image/*" multiple class="form-control">
        </div>

        <!-- Vista previa -->
        <div id="preview" class="d-flex flex-wrap mt-3"></div>

        <hr>
        <button type="submit" class="btn btn-primary">Guardar cambios</button>
        <a th:href="@{/destinoTuristicos}" class="btn btn-secondary">Regresar</a>
    </form>

    <script>
        let selectedFiles = [];

        document.getElementById("imagenFiles").addEventListener("change", function (event) {
            Array.from(event.target.files).forEach(file => {
                // Evitar duplicados (nombre + tamaño)
                let exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!exists && file.type.startsWith("image/")) {
                    selectedFiles.push(file);
                }
            });

            renderPreview();

            // Limpio el input para permitir volver a elegir más
            event.target.value = "";
        });

        function renderPreview() {
            let preview = document.getElementById("preview");
            preview.innerHTML = "";

            selectedFiles.forEach((file, index) => {
                let reader = new FileReader();
                reader.onload = function (e) {
                    let div = document.createElement("div");
                    div.style.position = "relative";
                    div.style.display = "inline-block";
                    div.style.margin = "5px";

                    let img = document.createElement("img");
                    img.src = e.target.result;
                    img.width = 120;
                    img.style.border = "1px solid #ccc";
                    img.style.borderRadius = "5px";
                    img.style.objectFit = "cover";

                    // Botón para eliminar la imagen de la selección
                    let btn = document.createElement("button");
                    btn.innerHTML = "×";
                    btn.type = "button";
                    btn.style.position = "absolute";
                    btn.style.top = "2px";
                    btn.style.right = "2px";
                    btn.style.background = "red";
                    btn.style.color = "white";
                    btn.style.border = "none";
                    btn.style.borderRadius = "50%";
                    btn.style.width = "22px";
                    btn.style.height = "22px";
                    btn.style.cursor = "pointer";

                    btn.onclick = function () {
                        selectedFiles.splice(index, 1);
                        renderPreview();
                    };

                    div.appendChild(img);
                    div.appendChild(btn);
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // Envío del formulario con las imágenes nuevas
        document.getElementById("destinoForm").addEventListener("submit", function (e) {
            e.preventDefault();

            let formData = new FormData(this);

            selectedFiles.forEach(file => {
                formData.append("imagenFiles", file);
            });

            fetch(this.action, {
                method: this.method,
                body: formData
            }).then(response => {
                if (response.ok) {
                    window.location.href = "/destinoTuristicos";
                } else {
                    alert("Error al guardar los cambios");
                }
            });
        });
    </script>
</div>


